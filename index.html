<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <title>基金看板</title>
    <script src="https://unpkg.com/vue@3.0.11"></script>
    <link rel="stylesheet" href="https://unpkg.com/element-plus/lib/theme-chalk/index.css">
    <script src="https://unpkg.com/element-plus/lib/index.full.js"></script>
    <script src="https://cdn.bootcdn.net/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script src="https://cdn.bootcdn.net/ajax/libs/bignumber.js/9.0.1/bignumber.min.js"></script>
    <style>
        body,
        html {
            font-family: 微软雅黑;
            padding: 0;
            margin: 0;
        }
    </style>
</head>

<body>
    <div id="app">
        <el-container>
            <el-header style="text-align: right; font-size: 12px;line-height: 60px;border-bottom: 1px solid #ccc;">
                <el-dropdown style="margin-left: 10px;">
                    <span class="el-dropdown-link" style="cursor: pointer;color: #409EFF;">
                        设置<i class="el-icon-arrow-down el-icon--right"></i>
                    </span>
                    <template #dropdown>
                        <el-dropdown-menu>
                            <el-dropdown-item @click="dialogFundVisible = true">基金管理</el-dropdown-item>
                            <el-dropdown-item>
                                <el-link href="https://github.com/zhangkong828/fund" target="_blank" :underline="false">
                                    GitHub</el-link>
                            </el-dropdown-item>
                        </el-dropdown-menu>
                    </template>
                </el-dropdown>
            </el-header>
            <el-main>

            </el-main>
        </el-container>
        <el-dialog title="基金管理" v-model="dialogFundVisible" :close-on-click-modal="false">
            <el-button type="primary" @click="dialogFundAddVisible = true">添加</el-button>
            <el-table :data="funds" style="width: 100%" max-height="450">
                <el-table-column prop="code" label="基金代码">
                </el-table-column>
                <el-table-column prop="ccdj" label="持仓单价">
                </el-table-column>
                <el-table-column prop="ccfe" label="持仓份额">
                </el-table-column>
                <el-table-column label="操作">
                    <template #default="scope">
                        <el-button @click.native.prevent="editFund(scope.$index, scope.row)" size="mini">编辑</el-button>
                        <el-button @click.native.prevent="delFund(scope.$index)" type="danger" size="mini">移除
                        </el-button>
                    </template>
                </el-table-column>
            </el-table>
            <el-dialog title="添加" v-model="dialogFundAddVisible" append-to-body>
                <el-form :model="fund">
                    <el-form-item label="基金代码">
                        <el-input v-model="fund.code" autocomplete="off"></el-input>
                    </el-form-item>
                    <el-form-item label="持仓单价">
                        <el-input v-model.number="fund.ccdj" autocomplete="off"></el-input>
                    </el-form-item>
                    <el-form-item label="持仓份额">
                        <el-input v-model.number="fund.ccfe" autocomplete="off"></el-input>
                    </el-form-item>
                </el-form>
                <template #footer>
                    <span class="dialog-footer">
                        <el-button @click="dialogFundAddVisible = false">取 消</el-button>
                        <el-button type="primary" @click="addFund">确 定</el-button>
                    </span>
                </template>
            </el-dialog>
        </el-dialog>
    </div>
    <script>
        const App = {
            data() {
                return {
                    dialogFundVisible: false,
                    dialogFundAddVisible: false,
                    funds: [],
                    fund: {
                        code: "",//基金代码
                        ccdj: 0,//持仓单价
                        ccfe: 0//持仓份额
                    }
                }
            },
            watch: {
                funds: {
                    handler(newValue, oldValue) {
                        var str = JSON.stringify(newValue);
                        localStorage.setItem('funds', str);
                    },
                    deep: true
                }
            },
            methods: {
                getFunds() {
                    var val = localStorage.getItem('funds');
                    if (val != null) {
                        this.funds = JSON.parse(val);
                        if (this.funds.length > 0) {
                            let i = 0;
                            this.funds.forEach(item => {
                                item.ccdj = new BigNumber(item.ccdj);
                                item.ccfe = new BigNumber(item.ccfe);
                                //持仓成本价
                                item.ccj = item.ccdj.times(item.ccfe);

                                let url = "http://fundgz.1234567.com.cn/js/" + item.code + ".js";
                                $.ajax({
                                    url: url,
                                    type: "GET",
                                    dataType: "jsonp",
                                    jsonpCallback: "jsonpgz",
                                    success: function (res) {
                                        //jsonpgz({"jzrq":"2021-02-23","dwjz":"1.5880","gsz":"1.5803","gszzl":"-0.49","gztime":"2021-02-24 15:00"});
                                        //console.log(res);
                                        //单位净值
                                        item.dwjz = new BigNumber(res["dwjz"]);
                                        //日期
                                        item.jzrq = res["jzrq"];
                                        item.gsz = new BigNumber(res["gsz"]);
                                        item.gszzl = new BigNumber(res["gszzl"]);
                                        item.gztime = res["gztime"];
                                        //计算净值价/净值盈利
                                        item.jzj = item.dwjz.times(item.ccfe);
                                        item.jzgetmoney = item.jzj.minus(item.ccj);
                                        //计算估值价/估值盈利
                                        item.gzj = item.gsz.times(item.ccfe);
                                        item.getmoney = item.gzj.minus(item.ccj);
                                        console.log(item);
                                        i++;
                                        //if (i == fundinfos.length) { console.log("ok") }
                                    }
                                });

                            });
                            return;
                        }
                    }
                    this.$message.error({ showClose: true, message: '请先添加基金代码' });
                },
                addFund() {
                    this.funds.push(this.fund);
                    this.fund = this.$options.data.call(this).fund;
                    this.dialogFundAddVisible = false;
                },
                delFund(index) {
                    this.funds.splice(index, 1);
                },
                editFund(index, row) { },
            },
            mounted() {
                this.getFunds();
            }
        }
        Vue.createApp(App).use(ElementPlus).mount('#app')
    </script>
</body>

</html>